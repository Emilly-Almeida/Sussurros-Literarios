{% extends "base.html" %}

{% block title %}{{ livro.titulo }} - Sussurros Literários{% endblock %}

{% block content %}
<div class="container">
    <div class="book-detail-container">
        <!-- Informações Principais do Livro -->
        <div class="book-detail-header">
            <div class="book-detail-cover">
                <img src="{{ livro.capa }}" alt="{{ livro.titulo }}">
            </div>
            <div class="book-detail-info">
                <h1>{{ livro.titulo }}</h1>
                <p class="book-author-large">
                    <i class="fas fa-user"></i>
                    {{ livro.autor }}
                </p>
                <div class="book-meta">
                    <span class="meta-item">
                        <i class="fas fa-tag"></i>
                        {{ livro.genero }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-building"></i>
                        {{ livro.editora }}
                    </span>
                    <span class="meta-item rating-large">
                        <i class="fas fa-star"></i>
                        {{ livro.nota }}/5.0
                    </span>
                </div>
                <div class="book-synopsis">
                    <h3>Sinopse</h3>
                    <p>{{ livro.sinopse }}</p>
                </div>
                <div class="book-actions">
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Adicionar à Lista
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-heart"></i>
                        Favoritar
                    </button>
                </div>
            </div>
        </div>

        <!-- Relações Visuais -->
        <section class="book-section">
            <div class="section-header">
                <h2>
                    <i class="fas fa-project-diagram"></i>
                    Relações no Grafo
                </h2>
                <p>Visualize as conexões deste livro</p>
            </div>
            <div id="bookGraph" style="height: 450px; border: 1px solid #e0e0e0; border-radius: 12px; background: #fafafa;"></div>
        </section>

        <!-- Leitores que gostaram -->
        <section class="book-section">
            <div class="section-header">
                <h2>
                    <i class="fas fa-users"></i>
                    Leitores que gostaram
                </h2>
            </div>
            {% if leitores %}
            <div class="readers-horizontal">
                {% for leitor in leitores %}
                <div class="reader-mini-card">
                    <a href="{{ url_for('perfil', usuario_id=leitor.id) }}">
                        <img src="{{ leitor.foto }}" alt="{{ leitor.nome }}">
                        <p>{{ leitor.nome }}</p>
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>Nenhum leitor ainda.</p>
            {% endif %}
        </section>

        <!-- Recomendações -->
        <section class="book-section">
            <div class="section-header">
                <h2>
                    <i class="fas fa-magic"></i>
                    Leitores que gostaram também leram...
                </h2>
            </div>
            {% if similares %}
            <div class="books-grid">
                {% for similar in similares %}
                <div class="book-card">
                    <a href="{{ url_for('livro', livro_id=similar.id) }}">
                        <div class="book-cover">
                            <img src="{{ similar.capa }}" alt="{{ similar.titulo }}">
                            <div class="book-rating">
                                <i class="fas fa-star"></i>
                                {{ similar.nota }}
                            </div>
                        </div>
                        <div class="book-info">
                            <h3>{{ similar.titulo }}</h3>
                            <p class="book-author">{{ similar.autor }}</p>
                            <span class="book-genre">{{ similar.genero }}</span>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>Nenhuma recomendação disponível.</p>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
{% endblock %}

{% block extra_js %}
<script>
    // Criar grafo de relações do livro
    const container = document.getElementById('bookGraph');
    
    if (container) {
        const nodes = new vis.DataSet([
            {id: 'book_{{ livro.id }}', label: '{{ livro.titulo }}', group: 'livro', color: '#3498db', size: 35, shape: 'box'},
            {id: 'author_{{ livro.autor }}', label: '{{ livro.autor }}', group: 'autor', color: '#e74c3c', size: 25, shape: 'diamond'},
            {id: 'genre_{{ livro.genero }}', label: '{{ livro.genero }}', group: 'genero', color: '#9b59b6', size: 25, shape: 'star'},
            {id: 'publisher_{{ livro.editora }}', label: '{{ livro.editora }}', group: 'editora', color: '#f39c12', size: 20, shape: 'triangle'}
            {% for similar in similares[:3] %}
            ,{id: 'book_{{ similar.id }}', label: '{{ similar.titulo }}', group: 'livro_similar', color: '#95a5a6', size: 20, shape: 'box'}
            {% endfor %}
        ]);

        const edges = new vis.DataSet([
            {from: 'author_{{ livro.autor }}', to: 'book_{{ livro.id }}', label: 'ESCREVEU', arrows: 'to', color: '#e74c3c'},
            {from: 'book_{{ livro.id }}', to: 'genre_{{ livro.genero }}', label: 'PERTENCE_A', arrows: 'to', color: '#9b59b6'},
            {from: 'book_{{ livro.id }}', to: 'publisher_{{ livro.editora }}', label: 'PUBLICADO_POR', arrows: 'to', color: '#f39c12'}
            {% for similar in similares[:3] %}
            ,{from: 'genre_{{ livro.genero }}', to: 'book_{{ similar.id }}', label: 'MESMO_GÊNERO', arrows: 'to', dashes: true, color: '#95a5a6'}
            {% endfor %}
        ]);

        const data = {nodes: nodes, edges: edges};
        
        const options = {
            nodes: {
                font: {
                    size: 14,
                    color: '#000000',
                    bold: {
                        color: '#ffffff'
                    }
                },
                borderWidth: 2,
                borderWidthSelected: 4
            },
            edges: {
                width: 2,
                smooth: {
                    type: 'continuous'
                },
                font: {
                    size: 11,
                    align: 'middle',
                    background: '#ffffff'
                }
            },
            physics: {
                stabilization: {
                    iterations: 200
                },
                barnesHut: {
                    gravitationalConstant: -3000,
                    springConstant: 0.001,
                    springLength: 200
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };

        const network = new vis.Network(container, data, options);
    }
</script>
{% endblock %}
